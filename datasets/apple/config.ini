# DeepFilterNet4 Training Configuration
# Optimized for Apple Silicon (M1/M2/M3/M4 chips)
#
# Usage:
#   python -m df.train dataset.cfg hdf5/ output_dir/
#
# This config demonstrates DFNet4's full feature set:
# - Mamba state-space model backbone
# - Multi-resolution deep filtering
# - Phase-aware processing
# - Optimized batch sizes for Apple Silicon unified memory
#
# Auto-tuning enabled: Set AUTO_TUNE=false to use manual values

[df]
# Core audio processing (48kHz native)
SR = 48000
FFT_SIZE = 960
HOP_SIZE = 480
NB_ERB = 32
NB_DF = 96
DF_ORDER = 5
DF_LOOKAHEAD = 0
NORM_TAU = 1.0
LSNR_MAX = 35
LSNR_MIN = -15
MIN_NB_ERB_FREQS = 2
PAD_MODE = input

[train]
# Model selection
MODEL = deepfilternet4
AUTO_TUNE = true

# Training duration
MAX_EPOCHS = 100
SEED = 42

# Batch sizes (auto-tuned if not set, these are Apple Silicon M3 Max defaults)
# BATCH_SIZE = 12
# BATCH_SIZE_EVAL = 24
# NUM_WORKERS = 4
# NUM_PREFETCH_BATCHES = 24

# Sample configuration
MAX_SAMPLE_LEN_S = 5.0
OVERFIT = false
LOG_TIMINGS = false

# Training modes
MASK_ONLY = false
DF_ONLY = false
JIT = false
START_EVAL = false
GLOBAL_DS_SAMPLING_F = 1.0

# Data augmentation SNRs and gains
DATALOADER_SNRS = -5, 0, 5, 10, 20, 40
DATALOADER_GAINS = -6, 0, 6

# Validation and early stopping
VALIDATION_CRITERIA = loss
VALIDATION_CRITERIA_RULE = min
EARLY_STOPPING_PATIENCE = 10

# GAN training (optional, disabled by default)
GAN_ENABLED = false
# GAN_START_EPOCH = 20
# DISCRIMINATOR_TYPE = combined
# DISCRIMINATOR_SPECTRAL_NORM = false
# MPD_PERIODS = 2, 3, 5, 7, 11
# MSD_SCALES = 3

[deepfilternet4]
# === Architecture Selection ===
# BACKBONE: "mamba" (state-space model) or "gru" (recurrent)
# Mamba provides O(n) complexity with excellent long-range modeling
BACKBONE = mamba

# Model variant: "full" (~2.6M params) or "lite" (~1.3M params)
MODEL_VARIANT = full

# === Convolution Configuration ===
CONV_LOOKAHEAD = 0
CONV_CH = 16
CONV_DEPTHWISE = true
CONVT_DEPTHWISE = true
CONV_KERNEL = 1, 3
CONVT_KERNEL = 1, 3
CONV_KERNEL_INP = 3, 3

# === Embedding Network ===
EMB_HIDDEN_DIM = 256
EMB_NUM_LAYERS = 2
EMB_GRU_SKIP_ENC = none
EMB_GRU_SKIP = none

# === Deep Filtering Network ===
DF_HIDDEN_DIM = 256
DF_GRU_SKIP = none
DF_PATHWAY_KERNEL_SIZE_T = 1
DF_NUM_LAYERS = 3
DF_N_ITER = 1
DF_ORDER = 5

# === Mamba Parameters ===
# SSM state dimension (larger = more expressive, more memory)
MAMBA_D_STATE = 16
# Local convolution width (larger = more local context)
MAMBA_D_CONV = 4
# Expansion factor for inner dimension
MAMBA_EXPAND = 2

# === Hybrid Encoder (optional time/phase branches) ===
# Time branch: processes raw waveform
USE_TIME_BRANCH = false
# Phase branch: explicitly models phase information
USE_PHASE_BRANCH = true
# Fusion type: "simple" (addition) or "attention" (cross-attention)
FUSION_TYPE = simple

# === Multi-Resolution Deep Filtering ===
# Enables frequency-dependent filter resolution
# Higher frequencies need less temporal context
USE_MULTI_RES_DF = true
# Format: "num_freqs,frame_size;..." (semicolon-separated resolutions)
# Default: 96 lowest bins @ order 5, 48 middle @ order 3, 24 high @ order 2
DF_RESOLUTIONS = 96,5;48,3;24,2

# === Adaptive Filter Order (experimental) ===
# Predicts optimal filter order per frame based on signal complexity
ADAPTIVE_ORDER = false
MAX_DF_ORDER = 7
MIN_DF_ORDER = 2

# === Efficiency Settings ===
LINEAR_GROUPS = 1
ENC_LINEAR_GROUPS = 16
ENC_CONCAT = false

# === Post-processing ===
MASK_PF = false
PF_BETA = 0.02
LSNR_DROPOUT = false

[optim]
# AdamW optimizer with cosine annealing
OPTIMIZER = adamw
LR = 5e-4
LR_MIN = 1e-6
LR_WARMUP = 1e-4
WARMUP_EPOCHS = 3
WEIGHT_DECAY = 0.05
WEIGHT_DECAY_END = -1
OPT_BETAS = 0.9, 0.999

# Learning rate cycling (optional)
LR_CYCLE_MUL = 1.0
LR_CYCLE_DECAY = 0.5
LR_CYCLE_EPOCHS = -1

# Discriminator optimizer (if GAN enabled)
DISCRIMINATOR_LR = 2e-4
DISCRIMINATOR_WEIGHT_DECAY = 0.0
DISCRIMINATOR_BETAS = 0.8, 0.99
DISCRIMINATOR_LR_MIN = 1e-6
DISCRIMINATOR_WARMUP_EPOCHS = 0

[distortion]
# Data augmentation probabilities
P_REVERB = 0.2
P_BANDWIDTH_EXT = 0.0
P_CLIPPING = 0.0
P_ZEROING = 0.0
P_AIR_ABSORPTION = 0.0
P_INTERFER_SP = 0.0

[loss]
# Multi-resolution STFT loss configuration
MULTI_RES_STFT_F = 1.0
MULTI_RES_STFT_GAMMA = 1.0

# ERB mask loss
ERB_LOSS_F = 1.0

# Deep filter coefficient loss (optional)
DF_LOSS_F = 0.0

# Perceptual losses (optional)
PERCEPTUAL_LOSS_F = 0.0
